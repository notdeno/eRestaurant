@model SEDC.PracticalAspNet.Business.Model.DtoMenu

@{
    ViewBag.Title = "Details";
}

<h2>@Model.MenuName</h2>
<hr class="add-item" />
<h2>
    categories:
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createCategoryModal">
        Add
    </button>
</h2>

<div id="app">

</div>

<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.Id }) |
    @Html.ActionLink("Back to List", "Index")
</p>

<!--create category modal goes here-->
<div id="createCategoryModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <!--modal  header goes here-->
                <h5 class="modal-title">Add Category</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!--modal  body goes here-->
                <form id="form_createCategory" action="/asdasdasd" method="post">
                    <input type="hidden" name="menuId" value="@Model.Id" />
                    <div class="form-group">
                        <label for="categoryName">Category Name</label>
                        <input type="text" name="categoryName" class="form-control" placeholder="Category Name" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="btn_createCategory" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!--create item modal goes here-->
<div id="createItemModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <!--modal  header goes here-->
                <h5 class="modal-title">Add Item</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!--modal  body goes here-->
                <form id="form_createItem" method="post">
                    <input type="hidden" name="categoryId" value="" id="selected-category-id" />
                    <div class="form-group">
                        <label for="categoryName">Category Name</label>
                        <input type="text" name="categoryName" class="form-control" placeholder="Category Name" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="btn_createItem" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

@section scripts{

    <script>
        // A $( document ).ready() block.
        $(document).ready(function () {

            var Person  = function(firstName, lastName) {

            }
            var person = new Person("xhevo","ibraimi");

            var App = function () {
                var _this = this;
                var createCategoryUrl = '/categories/create';
                var getCategoriesUrl = '/categories/getbymenu';
                var getItemsUrl = '/items/getbycategory';
                var createItemUrl = '/items/create';
                var btn_createCategory = $("#btn_createCategory");
                var form_createCategory = $("#form_createCategory")[0];
                var form_createItem = $("#form_createItem")[0];
                var selectedCategoryInput = $("#selected-category-id")[0];

                this.divId = "app";
                this.appDiv = null;
                var _state = {};

                btn_createCategory.on('click', function (event) {
                    _this.createCategory();
                });

                this.renderAccordionBeginning = function () {
                    return `<div class="panel-group" id="accordion">
                <div class="panel panel-default">`;
                }

                this.renderCategory = function (category, index) {
                    var result = `<div class="panel-heading${index === 0 ? " active" : ""}">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse${category.id}">
                                ${category.categoryName}
                            </a>
                        </h4>
                    </div>
                    <div id="collapse${category.id}" class="panel-collapse collapse ${index === 0 ? " in" : ""}">
                        <div class="panel-body">
                            ${_this.renderItemsTable(category)}
                        </div>
                    </div>`;
                    return result;
                };

                this.renderAccordionCategories = function () {
                    var result = "";
                    if (_state && _state.categories && _state.categories.length) {
                        $.each(_state.categories, function (index, category) {
                            result += _this.renderCategory(category, index);
                        });
                    }
                    return result;
                };

                this.renderAccordionEnding = function () {
                    return `</div></div>`;
                }

                this.init = function () {
                    _this.appDiv = $("#" + _this.divId);
                    if (!_this.appDiv.length) {
                        throw new Error(`div with the given id "${_this.divId}" was not found`);
                    }
                    $("body").on("click", ".add-item", function (e) {
                        console.log(e.target.getAttribute("data-category-id"));
                        selectedCategoryInput.value = e.target.getAttribute("data-category-id");
                        console.log(selectedCategoryInput);
                    });

                    _state.categories = [];
                    _this.render();
                    _this.fetchCategories();
                };

                this.render = function () {
                    var result = "";
                    result += _this.renderAccordionBeginning();
                    result += _this.renderAccordionCategories();
                    result += _this.renderAccordionEnding();
                    _this.appDiv.html("");
                    _this.appDiv.append(result);
                };

                this.fetchCategories = function () {
                    $.get(getCategoriesUrl + "?menuId=" + @Model.Id, function (data) {
                        _state.categories = data.map(function (x) {
                            return {
                                id: x.Id,
                                categoryName: x.CategoryName
                            };
                        });
                        _this.render();
                        if (_state.categories && _state.categories.length) {
                            _this.loadItems(_state.categories[0]);
                            //_state.categories[0].items = [{ itemId: 123, name: "coca cola" }];
                        }
                    });
                };

                this.loadItems = function (category) {
                    if (category && category.id) {
                        $.get(getItemsUrl + "?categoryId=" + category.id, function (items) {
                            _state.categories.filter(function (c) {
                                if (c && c.id === category.id) {
                                    console.log(items);
                                    //c.items = data
                                }
                            });
                        });
                    }
                }

                this.renderItemsTable = function (category) {
                    var result = `<table class="table table-responsive table-striped table-bordered">
                        <thead>
                            <tr>
                                 <td>Item Id</td>
                                <td>Name</td>
                                <td>
                                    <button data-category-id="${category.id}" class="btn btn-success add-item" data-toggle="modal" data-target="#createItemModal">+</button>
                                </td>
                            </tr>
                        </thead>
                        <tbody>
                            ${_this.renderItems(category)}
                        </tbody>
                </table >`;
                    return result;
                }

                this.renderItems = function (category) {
                    var result = "";
                    if (category && category.items && category.items.length) {
                        $.each(category.items, function (index,item) {
                            result += `<tr>
                                <td>${item.id}</td>
                                <td>${item.name}</td>
                                <td>
                                    <button data-item-id="${item.id}" class="btn btn-danger">-</button>
                                </td>
                            </tr>`
                        });
                    }
                    return result;
                }

                this.createCategory = function () {
                    var request = {
                        menuId: form_createCategory["menuId"].value,
                        categoryName: form_createCategory["categoryName"].value
                    };
                    $.post(createCategoryUrl, request, function (data) {
                        _state.categories.push({
                            id: data.Id,
                            categoryName: data.CategoryName
                        });
                        _this.render();
                    });
                };
            }



            var app = new App();
            app.divId = "app";
            app.init();
        });
        

//var createCategoryUrl = '/categories/create';
//var getCategoriesUrl = '/categories';
//var btn_createCategory = $("#btn_createCategory");

    </script>
}
